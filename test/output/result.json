{
  "type": "code",
  "elements": [
    {
      "type": "class_definition",
      "name": "Query",
      "block": {
        "type": "class_block",
        "elements": [
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "trellises",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "main_table",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "literal_string",
                  "text": "node"
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "joins",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "filters",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "post_clauses",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "limit",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "literal_string",
                  "text": ""
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "sources",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "links",
              "children": "",
              "index": ""
            },
            "value": [
              {
                "type": "expression",
                "contents": {
                  "type": "create_array",
                  "arguments": {
                    "type": "arguments",
                    "expressions": [
                      ""
                    ]
                  }
                }
              }
            ]
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "trellis",
              "children": "",
              "index": ""
            }
          },
          {
            "type": "property",
            "variable": {
              "type": "variable",
              "name": "db",
              "children": "",
              "index": ""
            }
          },
          {
            "type": "method_definition",
            "name": "__construct",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "trellis",
                  "default_value": ""
                },
                {
                  "type": "parameter",
                  "name": "include_links",
                  "default_value": "true"
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                {
                  "type": "control",
                  "name": "if",
                  "condition": [
                    {
                      "type": "expression_list",
                      "expressions": [
                        {
                          "type": "expression",
                          "contents": {
                            "type": "invoke_function",
                            "name": "get_class",
                            "arguments": {
                              "type": "arguments",
                              "expressions": [
                                {
                                  "type": "expression",
                                  "contents": {
                                    "type": "variable",
                                    "name": "trellis",
                                    "children": "",
                                    "index": ""
                                  }
                                }
                              ]
                            }
                          }
                        },
                        [
                          [],
                          {
                            "type": "operator",
                            "symbol": "!="
                          },
                          {
                            "type": "expression",
                            "contents": {
                              "type": "literal_string",
                              "text": "Trellis"
                            }
                          }
                        ],
                        [
                          [],
                          {
                            "type": "operator",
                            "symbol": "&&"
                          },
                          {
                            "type": "expression",
                            "contents": [
                              "!",
                              [],
                              {
                                "type": "expression",
                                "contents": {
                                  "type": "invoke_function",
                                  "name": "is_subclass_of",
                                  "arguments": {
                                    "type": "arguments",
                                    "expressions": [
                                      {
                                        "type": "expression",
                                        "contents": {
                                          "type": "variable",
                                          "name": "trellis",
                                          "children": "",
                                          "index": ""
                                        }
                                      },
                                      {
                                        "type": "expression",
                                        "contents": {
                                          "type": "literal_string",
                                          "text": "Trellis"
                                        }
                                      }
                                    ]
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      ]
                    }
                  ],
                  "block": {
                    "type": "block",
                    "elements": [
                      [
                        "\n",
                        " ",
                        " ",
                        " ",
                        " ",
                        " ",
                        " "
                      ],
                      {
                        "type": "exception_raise",
                        "expression": {
                          "type": "expression",
                          "contents": [
                            "new",
                            {
                              "type": "invoke_function",
                              "name": "Exception",
                              "arguments": {
                                "type": "arguments",
                                "expressions": [
                                  {
                                    "type": "expression",
                                    "contents": {
                                      "type": "literal_string",
                                      "text": "An invalid trellis was passed to the Query constructor."
                                    }
                                  }
                                ]
                              }
                            }
                          ]
                        }
                      }
                    ],
                    "variables": {}
                  }
                },
                [
                  {
                    "type": "expression_list",
                    "expressions": [
                      {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "this",
                          "children": "->trellis",
                          "index": ""
                        }
                      },
                      [
                        [],
                        {
                          "type": "operator",
                          "symbol": "="
                        },
                        {
                          "type": "expression",
                          "contents": {
                            "type": "variable",
                            "name": "trellis",
                            "children": "",
                            "index": ""
                          }
                        }
                      ]
                    ]
                  },
                  {
                    "type": "terminator"
                  }
                ],
                [
                  {
                    "type": "expression_list",
                    "expressions": [
                      {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "this",
                          "children": "->ground",
                          "index": ""
                        }
                      },
                      [
                        [],
                        {
                          "type": "operator",
                          "symbol": "="
                        },
                        {
                          "type": "expression",
                          "contents": {
                            "type": "variable",
                            "name": "this",
                            "children": "->trellis->ground",
                            "index": ""
                          }
                        }
                      ]
                    ]
                  },
                  {
                    "type": "terminator"
                  }
                ],
                [
                  {
                    "type": "expression_list",
                    "expressions": [
                      {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "this",
                          "children": "->db",
                          "index": ""
                        }
                      },
                      [
                        [],
                        {
                          "type": "operator",
                          "symbol": "="
                        },
                        {
                          "type": "expression",
                          "contents": {
                            "type": "variable",
                            "name": "this",
                            "children": "->ground->db",
                            "index": ""
                          }
                        }
                      ]
                    ]
                  },
                  {
                    "type": "terminator"
                  }
                ],
                [
                  {
                    "type": "expression_list",
                    "expressions": [
                      {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "this",
                          "children": "->main_table",
                          "index": ""
                        }
                      },
                      [
                        [],
                        {
                          "type": "operator",
                          "symbol": "="
                        },
                        {
                          "type": "expression",
                          "contents": {
                            "type": "invoke_method",
                            "object": {
                              "type": "variable",
                              "name": "trellis",
                              "children": "",
                              "index": ""
                            },
                            "method": {
                              "type": "invoke_function",
                              "name": "get_table_name",
                              "arguments": {
                                "type": "arguments",
                                "expressions": [
                                  ""
                                ]
                              }
                            }
                          }
                        }
                      ]
                    ]
                  },
                  {
                    "type": "terminator"
                  }
                ],
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "invoke_method",
                      "object": {
                        "type": "variable",
                        "name": "this",
                        "children": "",
                        "index": ""
                      },
                      "method": {
                        "type": "invoke_function",
                        "name": "add_source",
                        "arguments": {
                          "type": "arguments",
                          "expressions": [
                            {
                              "type": "expression",
                              "contents": {
                                "type": "variable",
                                "name": "trellis",
                                "children": "",
                                "index": ""
                              }
                            }
                          ]
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ],
                {
                  "type": "control",
                  "name": "if",
                  "condition": [
                    {
                      "type": "expression",
                      "contents": {
                        "type": "variable",
                        "name": "include_links",
                        "children": "",
                        "index": ""
                      }
                    }
                  ],
                  "block": {
                    "type": "block",
                    "elements": [
                      [
                        {
                          "type": "expression_list",
                          "expressions": [
                            {
                              "type": "expression",
                              "contents": {
                                "type": "variable",
                                "name": "current_trellis",
                                "children": "",
                                "index": ""
                              }
                            },
                            [
                              [],
                              {
                                "type": "operator",
                                "symbol": "="
                              },
                              {
                                "type": "expression",
                                "contents": {
                                  "type": "variable",
                                  "name": "trellis",
                                  "children": "",
                                  "index": ""
                                }
                              }
                            ]
                          ]
                        },
                        {
                          "type": "terminator"
                        }
                      ],
                      {
                        "type": "control",
                        "name": "do",
                        "condition": {
                          "type": "expression_list",
                          "expressions": [
                            {
                              "type": "expression",
                              "contents": {
                                "type": "variable",
                                "name": "current_trellis",
                                "children": "",
                                "index": ""
                              }
                            },
                            [
                              [],
                              {
                                "type": "operator",
                                "symbol": "="
                              },
                              {
                                "type": "expression",
                                "contents": {
                                  "type": "variable",
                                  "name": "current_trellis",
                                  "children": "->parent",
                                  "index": ""
                                }
                              }
                            ]
                          ]
                        },
                        "block": {
                          "type": "block",
                          "elements": [
                            [
                              "\n",
                              " ",
                              " ",
                              " ",
                              " ",
                              " ",
                              " ",
                              " ",
                              " "
                            ],
                            {
                              "type": "foreach_object",
                              "object": {
                                "type": "variable",
                                "name": "current_trellis",
                                "children": "->links",
                                "index": ""
                              },
                              "key": "",
                              "value": {
                                "type": "variable",
                                "name": "link",
                                "children": "",
                                "index": ""
                              },
                              "block": {
                                "type": "block",
                                "elements": [
                                  [
                                    {
                                      "type": "expression",
                                      "contents": {
                                        "type": "invoke_method",
                                        "object": {
                                          "type": "variable",
                                          "name": "this",
                                          "children": "",
                                          "index": ""
                                        },
                                        "method": {
                                          "type": "invoke_function",
                                          "name": "add_link",
                                          "arguments": {
                                            "type": "arguments",
                                            "expressions": [
                                              {
                                                "type": "expression",
                                                "contents": {
                                                  "type": "variable",
                                                  "name": "link",
                                                  "children": "",
                                                  "index": ""
                                                }
                                              }
                                            ]
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "terminator"
                                    }
                                  ]
                                ],
                                "variables": {
                                  "this": {
                                    "type": "variable",
                                    "name": "this",
                                    "children": "",
                                    "index": ""
                                  },
                                  "link": {
                                    "type": "variable",
                                    "name": "link",
                                    "children": "",
                                    "index": ""
                                  }
                                }
                              }
                            }
                          ],
                          "variables": {
                            "current_trellis": {
                              "type": "variable",
                              "name": "current_trellis",
                              "children": "->links",
                              "index": ""
                            },
                            "link": {
                              "type": "variable",
                              "name": "link",
                              "children": "",
                              "index": ""
                            },
                            "this": {
                              "type": "variable",
                              "name": "this",
                              "children": "",
                              "index": ""
                            }
                          }
                        }
                      }
                    ],
                    "variables": {
                      "current_trellis": {
                        "type": "variable",
                        "name": "current_trellis",
                        "children": "->links",
                        "index": ""
                      },
                      "trellis": {
                        "type": "variable",
                        "name": "trellis",
                        "children": "",
                        "index": ""
                      },
                      "link": {
                        "type": "variable",
                        "name": "link",
                        "children": "",
                        "index": ""
                      },
                      "this": {
                        "type": "variable",
                        "name": "this",
                        "children": "",
                        "index": ""
                      }
                    }
                  }
                }
              ],
              "variables": {
                "trellis": {
                  "type": "variable",
                  "name": "trellis",
                  "children": "",
                  "index": ""
                },
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "",
                  "index": ""
                },
                "include_links": {
                  "type": "variable",
                  "name": "include_links",
                  "children": "",
                  "index": ""
                },
                "current_trellis": {
                  "type": "variable",
                  "name": "current_trellis",
                  "children": "->links",
                  "index": ""
                },
                "link": {
                  "type": "variable",
                  "name": "link",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": true
          },
          {
            "type": "method_definition",
            "name": "add_source",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "source",
                  "default_value": ""
                },
                {
                  "type": "parameter",
                  "name": "include_primary_key",
                  "default_value": "true"
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "array_append",
                      "variable": {
                        "type": "variable",
                        "name": "this",
                        "children": "->sources",
                        "index": "[]"
                      },
                      "expression": {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "source",
                          "children": "",
                          "index": ""
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ],
                [
                  {
                    "type": "expression_list",
                    "expressions": [
                      {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "table_name",
                          "children": "",
                          "index": ""
                        }
                      },
                      [
                        [],
                        {
                          "type": "operator",
                          "symbol": "="
                        },
                        {
                          "type": "expression",
                          "contents": {
                            "type": "invoke_method",
                            "object": {
                              "type": "variable",
                              "name": "source",
                              "children": "",
                              "index": ""
                            },
                            "method": {
                              "type": "invoke_function",
                              "name": "get_table_name",
                              "arguments": {
                                "type": "arguments",
                                "expressions": [
                                  ""
                                ]
                              }
                            }
                          }
                        }
                      ]
                    ]
                  },
                  {
                    "type": "terminator"
                  }
                ],
                {
                  "type": "foreach_object",
                  "object": {
                    "type": "variable",
                    "name": "source",
                    "children": "->core_properties",
                    "index": ""
                  },
                  "key": "",
                  "value": {
                    "type": "variable",
                    "name": "property",
                    "children": "",
                    "index": ""
                  },
                  "block": {
                    "type": "block",
                    "elements": [
                      {
                        "type": "control",
                        "name": "if",
                        "condition": [
                          {
                            "type": "expression_list",
                            "expressions": [
                              {
                                "type": "expression",
                                "contents": {
                                  "type": "variable",
                                  "name": "property",
                                  "children": "->name",
                                  "index": ""
                                }
                              },
                              [
                                [],
                                {
                                  "type": "operator",
                                  "symbol": "!="
                                },
                                {
                                  "type": "expression",
                                  "contents": {
                                    "type": "variable",
                                    "name": "source",
                                    "children": "->primary_key",
                                    "index": ""
                                  }
                                }
                              ],
                              [
                                [],
                                {
                                  "type": "operator",
                                  "symbol": "||"
                                },
                                {
                                  "type": "expression",
                                  "contents": {
                                    "type": "variable",
                                    "name": "include_primary_key",
                                    "children": "",
                                    "index": ""
                                  }
                                }
                              ]
                            ]
                          }
                        ],
                        "block": {
                          "type": "block",
                          "elements": [
                            [
                              {
                                "type": "expression",
                                "contents": {
                                  "type": "invoke_method",
                                  "object": {
                                    "type": "variable",
                                    "name": "this",
                                    "children": "",
                                    "index": ""
                                  },
                                  "method": {
                                    "type": "invoke_function",
                                    "name": "add_field",
                                    "arguments": {
                                      "type": "arguments",
                                      "expressions": [
                                        {
                                          "type": "expression_list",
                                          "expressions": [
                                            {
                                              "type": "expression",
                                              "contents": {
                                                "type": "variable",
                                                "name": "table_name",
                                                "children": "",
                                                "index": ""
                                              }
                                            },
                                            [
                                              [],
                                              {
                                                "type": "operator",
                                                "symbol": "."
                                              },
                                              {
                                                "type": "expression",
                                                "contents": {
                                                  "type": "literal_string",
                                                  "text": "."
                                                }
                                              }
                                            ],
                                            [
                                              [],
                                              {
                                                "type": "operator",
                                                "symbol": "."
                                              },
                                              {
                                                "type": "expression",
                                                "contents": {
                                                  "type": "variable",
                                                  "name": "property",
                                                  "children": "->field_name",
                                                  "index": ""
                                                }
                                              }
                                            ]
                                          ]
                                        }
                                      ]
                                    }
                                  }
                                }
                              },
                              {
                                "type": "terminator"
                              }
                            ],
                            []
                          ],
                          "variables": {
                            "this": {
                              "type": "variable",
                              "name": "this",
                              "children": "",
                              "index": ""
                            },
                            "table_name": {
                              "type": "variable",
                              "name": "table_name",
                              "children": "",
                              "index": ""
                            },
                            "property": {
                              "type": "variable",
                              "name": "property",
                              "children": "->field_name",
                              "index": ""
                            }
                          }
                        }
                      }
                    ],
                    "variables": {
                      "property": {
                        "type": "variable",
                        "name": "property",
                        "children": "->field_name",
                        "index": ""
                      },
                      "source": {
                        "type": "variable",
                        "name": "source",
                        "children": "->primary_key",
                        "index": ""
                      },
                      "include_primary_key": {
                        "type": "variable",
                        "name": "include_primary_key",
                        "children": "",
                        "index": ""
                      },
                      "this": {
                        "type": "variable",
                        "name": "this",
                        "children": "",
                        "index": ""
                      },
                      "table_name": {
                        "type": "variable",
                        "name": "table_name",
                        "children": "",
                        "index": ""
                      }
                    }
                  }
                },
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "invoke_method",
                      "object": {
                        "type": "variable",
                        "name": "source",
                        "children": "",
                        "index": ""
                      },
                      "method": {
                        "type": "invoke_function",
                        "name": "parent_query",
                        "arguments": {
                          "type": "arguments",
                          "expressions": [
                            {
                              "type": "expression",
                              "contents": {
                                "type": "variable",
                                "name": "this",
                                "children": "",
                                "index": ""
                              }
                            }
                          ]
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ]
              ],
              "variables": {
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "",
                  "index": ""
                },
                "source": {
                  "type": "variable",
                  "name": "source",
                  "children": "",
                  "index": ""
                },
                "table_name": {
                  "type": "variable",
                  "name": "table_name",
                  "children": "",
                  "index": ""
                },
                "property": {
                  "type": "variable",
                  "name": "property",
                  "children": "->field_name",
                  "index": ""
                },
                "include_primary_key": {
                  "type": "variable",
                  "name": "include_primary_key",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": false
          },
          {
            "type": "method_definition",
            "name": "add_filter",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "clause",
                  "default_value": ""
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "array_append",
                      "variable": {
                        "type": "variable",
                        "name": "this",
                        "children": "->filters",
                        "index": "[]"
                      },
                      "expression": {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "clause",
                          "children": "",
                          "index": ""
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ]
              ],
              "variables": {
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "->filters",
                  "index": "[]"
                },
                "clause": {
                  "type": "variable",
                  "name": "clause",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": false
          },
          {
            "type": "method_definition",
            "name": "add_field",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "clause",
                  "default_value": ""
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "array_append",
                      "variable": {
                        "type": "variable",
                        "name": "this",
                        "children": "->fields",
                        "index": "[]"
                      },
                      "expression": {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "clause",
                          "children": "",
                          "index": ""
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ]
              ],
              "variables": {
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "->fields",
                  "index": "[]"
                },
                "clause": {
                  "type": "variable",
                  "name": "clause",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": false
          },
          {
            "type": "method_definition",
            "name": "add_join",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "clause",
                  "default_value": ""
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "array_append",
                      "variable": {
                        "type": "variable",
                        "name": "this",
                        "children": "->joins",
                        "index": "[]"
                      },
                      "expression": {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "clause",
                          "children": "",
                          "index": ""
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ]
              ],
              "variables": {
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "->joins",
                  "index": "[]"
                },
                "clause": {
                  "type": "variable",
                  "name": "clause",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": false
          },
          {
            "type": "method_definition",
            "name": "add_post",
            "parameters": {
              "type": "parameters",
              "variables": [
                {
                  "type": "parameter",
                  "name": "clause",
                  "default_value": ""
                }
              ]
            },
            "block": {
              "type": "block",
              "elements": [
                [
                  {
                    "type": "expression",
                    "contents": {
                      "type": "array_append",
                      "variable": {
                        "type": "variable",
                        "name": "this",
                        "children": "->post_clauses",
                        "index": "[]"
                      },
                      "expression": {
                        "type": "expression",
                        "contents": {
                          "type": "variable",
                          "name": "clause",
                          "children": "",
                          "index": ""
                        }
                      }
                    }
                  },
                  {
                    "type": "terminator"
                  }
                ]
              ],
              "variables": {
                "this": {
                  "type": "variable",
                  "name": "this",
                  "children": "->post_clauses",
                  "index": "[]"
                },
                "clause": {
                  "type": "variable",
                  "name": "clause",
                  "children": "",
                  "index": ""
                }
              }
            },
            "constructor": false
          }
        ]
      }
    }
  ]
}